package com.telefonica.mistica.tokens

import com.squareup.moshi.JsonAdapter
import com.squareup.moshi.Moshi
import com.squareup.moshi.kotlin.reflect.KotlinJsonAdapterFactory
import com.squareup.moshi.adapters.PolymorphicJsonAdapterFactory
import com.telefonica.mistica.tokens.compose.GenerateComposeFiles
import com.telefonica.mistica.tokens.dto.BrushDTO
import com.telefonica.mistica.tokens.dto.TokensDTO
import com.telefonica.mistica.tokens.xml.GenerateXMLFiles

class TokensGenerator(
    private val generateXMLFiles: GenerateXMLFiles = GenerateXMLFiles(),
    private val generateComposeFiles: GenerateComposeFiles = GenerateComposeFiles(),
) {

    fun generate() {
        val brushAdapter = PolymorphicJsonAdapterFactory.of(BrushDTO::class.java, BrushDTO.TYPE_FIELD_NAME)
            .withSubtype(BrushDTO.SolidColorDTO::class.java, BrushDTO.COLOR_TYPE)
            .withSubtype(BrushDTO.GradientDTO::class.java, BrushDTO.GRADIENT_TYPE)

        val moshi: Moshi = Moshi.Builder()
            .add(brushAdapter)
            .addLast(KotlinJsonAdapterFactory())
            .build()
        val jsonAdapter: JsonAdapter<TokensDTO> = moshi.adapter(TokensDTO::class.java)

        generateXMLFiles(jsonAdapter)
        generateComposeFiles(jsonAdapter)
    }

    companion object {
        val BRANDS = listOf(
            Brand("blau", "blau"),
            Brand("movistar", "movistar"),
            Brand("o2", "o2"),
            Brand("telefonica", "telefonica"),
            Brand("vivo", "vivo"),
            Brand("vivoNew", "vivo-new", createDuplicateWithoutInheritMistica = true),
            Brand("tu", "tu"),
            Brand("o2New", "o2-new"),
        )

        val ALPHA_REGEX = "0\\.\\d{1,2}".toRegex()
        val COLOR_NAME_REGEX = "\\{palette\\.(.*)\\}".toRegex()

        const val AUTOGENERATED_COMMENT = "Code generated automatically, DO NOT EDIT manually. Use Import design tokens GitHub Action."
        const val MISTICA_TOKENS_DIR = "../temp/mistica-design/tokens"
        const val CIRCLE_RADIUS = "circle"
        const val LIGHT = "light"
        const val REGULAR = "regular"
        const val MEDIUM = "medium"
        const val BOLD = "bold"
    }
}
